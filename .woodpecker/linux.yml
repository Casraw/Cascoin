# Linux Build Pipeline

labels:
  platform: linux/amd64

clone:
  git:
    image: woodpeckerci/plugin-git
    settings:
      recursive: true
      submodule_update_remote: true

when:
  - event: push
  - event: pull_request
  - event: tag
  - event: manual

steps:
  - name: build-linux
    image: ubuntu:25.04
    commands:
      - echo "Workspace is $PWD"
      - ls -la
      - apt-get update
      - apt-get install -y autoconf automake libtool build-essential pkg-config curl ca-certificates libevent-dev libboost-all-dev libssl-dev libzmq3-dev libminiupnpc-dev libprotobuf-dev protobuf-compiler libqrencode-dev libsqlite3-dev qt6-base-dev qt6-base-dev-tools qt6-tools-dev qt6-tools-dev-tools qt6-svg-dev qt6-l10n-tools libqt6core5compat6-dev binutils ccache libdb-dev libdb++-dev libdb5.3++-dev cmake git ninja-build libgmp-dev bsdextrautils locales astyle || true
      - sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen
      - locale-gen en_US.UTF-8
      # Build liboqs 0.12.0 (Open Quantum Safe)
      - cd /tmp && rm -rf liboqs && git clone --depth 1 --branch 0.12.0 https://github.com/open-quantum-safe/liboqs.git && cd liboqs && mkdir -p build && cd build && cmake -GNinja .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_SHARED_LIBS=ON -DOQS_BUILD_ONLY_LIB=ON && ninja && ninja install
      - ldconfig
      - mkdir -p /usr/local/lib/pkgconfig
      - "printf 'prefix=/usr/local\\nexec_prefix=${prefix}\\nlibdir=${exec_prefix}/lib\\nincludedir=${prefix}/include\\n\\nName: liboqs\\nDescription: Open Quantum Safe library\\nVersion: 0.12.0\\nLibs: -L${libdir} -loqs\\nCflags: -I${includedir}\\n' > /usr/local/lib/pkgconfig/liboqs.pc"
      - pkg-config --modversion liboqs || echo "liboqs pkg-config check"
      # Build EVMC 12.1.0
      - cd /tmp && git clone --recursive https://github.com/ethereum/evmc.git && cd evmc && git checkout v12.1.0 && mkdir -p build && cd build && cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DEVMC_TESTING=OFF -DEVMC_TOOLS=OFF -DEVMC_EXAMPLES=OFF -DBUILD_SHARED_LIBS=ON && make -j$(nproc) && make install
      - cd /tmp && git clone https://github.com/supranational/blst.git && cd blst && git checkout v0.3.13 && ./build.sh && cp libblst.a /usr/local/lib/ && cp bindings/blst.h bindings/blst_aux.h /usr/local/include/
      - cd /tmp && git clone --recursive https://github.com/ethereum/evmone.git && cd evmone && git checkout v0.18.0 && mkdir -p build && cd build && cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DEVMONE_TESTING=OFF -DEVMONE_FUZZING=OFF -DBUILD_SHARED_LIBS=ON && make -j$(nproc) && make install
      - ldconfig
      - mkdir -p /usr/local/lib/pkgconfig
      - "printf 'prefix=/usr/local\\nexec_prefix=$${prefix}\\nlibdir=$${exec_prefix}/lib\\nincludedir=$${prefix}/include\\n\\nName: evmc\\nDescription: Ethereum Virtual Machine Connector\\nVersion: 12.1.0\\nLibs: -L$${libdir} -levmc-loader\\nCflags: -I$${includedir}\\n' > /usr/local/lib/pkgconfig/evmc.pc"
      - "printf 'prefix=/usr/local\\nexec_prefix=$${prefix}\\nlibdir=$${exec_prefix}/lib\\nincludedir=$${prefix}/include\\n\\nName: evmone\\nDescription: Fast Ethereum Virtual Machine implementation\\nVersion: 0.18.0\\nRequires: evmc\\nLibs: -L$${libdir} -levmone\\nCflags: -I$${includedir}\\n' > /usr/local/lib/pkgconfig/evmone.pc"
      - cat /usr/local/lib/pkgconfig/evmc.pc
      - cat /usr/local/lib/pkgconfig/evmone.pc
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && git submodule update --init --recursive
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && git submodule status
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && ls -la src/secp256k1/ || echo "secp256k1 dir missing"
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && ls -la src/secp256k1/include/ || echo "secp256k1/include missing"
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && test -f src/secp256k1/include/secp256k1.h && echo "secp256k1.h exists" || echo "secp256k1.h MISSING"
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && test -f src/secp256k1/configure.ac || (echo "secp256k1 submodule incomplete, re-cloning" && rm -rf src/secp256k1 && git clone https://github.com/bitcoin-core/secp256k1.git src/secp256k1)
      # Build secp256k1 BEFORE main autogen/configure to ensure headers and library are ready
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin/src/secp256k1 && bash ./autogen.sh
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin/src/secp256k1 && ./configure --disable-shared --with-pic --enable-module-recovery --disable-jni
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin/src/secp256k1 && make -j$(nproc)
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && bash ./autogen.sh
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig" && CFLAGS="-g" CXXFLAGS="-g" MOC=/usr/lib/qt6/libexec/moc UIC=/usr/lib/qt6/libexec/uic RCC=/usr/lib/qt6/libexec/rcc LRELEASE=/usr/lib/qt6/bin/lrelease LUPDATE=/usr/lib/qt6/bin/lupdate ./configure --with-gui=qt6 --with-boost=/usr --with-boost-libdir=/usr/lib/x86_64-linux-gnu --enable-wallet --enable-evmc --with-evmc=/usr/local --with-evmone=/usr/local --with-incompatible-bdb --enable-quantum
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8 make -j$(nproc)
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && ls -lah src/ || true
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && ls -lah src/qt/ || true
      - cd /woodpecker/src/codeberg.org/Cascoin/Cascoin && file src/qt/*-qt || true
